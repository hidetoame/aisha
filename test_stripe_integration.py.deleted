#!/usr/bin/env python3
"""
Stripe設定をテストするスクリプト
"""

import requests
import json

def test_stripe_config():
    """Stripe設定APIのテスト"""
    api_url = "http://localhost:7999/api/stripe/config/"
    
    print("Stripe設定APIテスト開始...")
    print(f"URL: {api_url}")
    
    try:
        response = requests.get(api_url, timeout=10)
        
        print(f"\nレスポンス:")
        print(f"ステータス: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            print(f"成功: {json.dumps(result, indent=2)}")
            
            # Stripeキーが設定されているかチェック
            pub_key = result.get('publishable_key', '')
            if pub_key and pub_key.startswith('pk_'):
                print("✅ Stripe公開可能キーが正しく設定されています")
            else:
                print("❌ Stripe公開可能キーが正しく設定されていません")
                
        else:
            print(f"エラー: {response.text}")
            
    except Exception as e:
        print(f"例外発生: {e}")

def test_charge_api():
    """チャージAPIのテスト"""
    api_url = "http://localhost:7999/api/charges/"
    
    test_data = {
        "user_id": "test_user",
        "charge_amount": 500.00,
        "credit_amount": 500
    }
    
    print("\nチャージAPIテスト開始...")
    print(f"URL: {api_url}")
    print(f"データ: {json.dumps(test_data, indent=2)}")
    
    try:
        response = requests.post(
            api_url,
            json=test_data,
            headers={'Content-Type': 'application/json'},
            timeout=30
        )
        
        print(f"\nレスポンス:")
        print(f"ステータス: {response.status_code}")
        
        if response.status_code == 201:
            result = response.json()
            print(f"成功: {json.dumps(result, indent=2)}")
            
            # 必要なフィールドが含まれているかチェック
            required_fields = ['charge_id', 'payment_intent_id', 'client_secret', 'amount']
            for field in required_fields:
                if field in result:
                    print(f"✅ {field}: {result[field]}")
                else:
                    print(f"❌ 不足フィールド: {field}")
                    
        else:
            print(f"エラー: {response.text}")
            
    except Exception as e:
        print(f"例外発生: {e}")

if __name__ == "__main__":
    test_stripe_config()
    test_charge_api()
