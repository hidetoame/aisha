name: Deploy AISHA to GCP

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PROJECT_ID: aisha-462412
  REGION: asia-northeast1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Configure Docker for GCP
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ¬ç•ªç”¨Dockerfileæº–å‚™
    - name: Prepare Backend Production Dockerfile
      run: |
        cd pycharm_project
        # ãƒ­ãƒ¼ã‚«ãƒ«ç”¨Dockerfileã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        mv Dockerfile Dockerfile.local.backup
        # æœ¬ç•ªç”¨Dockerfileã‚’ä½¿ç”¨
        cp Dockerfile.production Dockerfile
        echo "âœ… æœ¬ç•ªç”¨Dockerfileã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: Deploy Backend to Cloud Run
      run: |
        gcloud run deploy aisha-backend \
          --source ./pycharm_project \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars DEBUG=False \
          --set-env-vars DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }} \
          --set-env-vars ALLOWED_HOSTS=*.run.app \
          --set-env-vars DATABASE_URL=${{ secrets.DATABASE_URL }} \
          --set-env-vars POSTGRES_DB=aisha_prod \
          --set-env-vars POSTGRES_USER=aisha_user \
          --set-env-vars POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
          --set-env-vars POSTGRES_HOST="/cloudsql/${{ env.PROJECT_ID }}:${{ env.REGION }}:aisha-db" \
          --set-env-vars POSTGRES_PORT=5432 \
          --add-cloudsql-instances ${{ env.PROJECT_ID }}:${{ env.REGION }}:aisha-db
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URLå–å¾—
    - name: Get Backend URL
      run: |
        BACKEND_URL=$(gcloud run services describe aisha-backend --region ${{ env.REGION }} --format 'value(status.url)')
        echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
        echo "âœ… Backend URL: $BACKEND_URL"
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ¬ç•ªç”¨Dockerfileæº–å‚™
    - name: Prepare Frontend Production Dockerfile
      run: |
        cd react_project
        # ãƒ­ãƒ¼ã‚«ãƒ«ç”¨Dockerfileã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        mv Dockerfile Dockerfile.local.backup
        # æœ¬ç•ªç”¨Dockerfileã‚’ä½¿ç”¨
        cp Dockerfile.production Dockerfile
        echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ¬ç•ªç”¨Dockerfileã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: Deploy Frontend to Cloud Run
      run: |
        gcloud run deploy aisha-frontend \
          --source ./react_project \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars NODE_ENV=production \
          --set-env-vars VITE_AISHA_API_BASE=${{ env.BACKEND_URL }}/api
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLå–å¾—
    - name: Get Frontend URL
      run: |
        FRONTEND_URL=$(gcloud run services describe aisha-frontend --region ${{ env.REGION }} --format 'value(status.url)')
        echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_ENV
        echo "âœ… Frontend URL: $FRONTEND_URL"
    
    # Dockerfileã‚’å…ƒã«æˆ»ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒä¿è­·ï¼‰
    - name: Restore Original Dockerfiles
      if: always()  # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
      run: |
        echo "ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨Dockerfileã‚’å¾©å…ƒä¸­..."
        cd pycharm_project
        if [ -f "Dockerfile.local.backup" ]; then
          mv Dockerfile.local.backup Dockerfile
          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Dockerfileå¾©å…ƒå®Œäº†"
        fi
        cd ../react_project
        if [ -f "Dockerfile.local.backup" ]; then
          mv Dockerfile.local.backup Dockerfile
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰Dockerfileå¾©å…ƒå®Œäº†"
        fi
        echo "ğŸ›¡ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ä¿è­·ã—ã¾ã—ãŸ"
    
    # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœè¡¨ç¤º
    - name: Display Deployment Results
      run: |
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
        echo ""
        echo "ğŸ“ æœ¬ç•ªç’°å¢ƒURL:"
        echo "Frontend: ${{ env.FRONTEND_URL }}"
        echo "Backend: ${{ env.BACKEND_URL }}"
        echo ""
        echo "ğŸ” ç¢ºèªæ–¹æ³•:"
        echo "1. Frontend URL ã«ã‚¢ã‚¯ã‚»ã‚¹"
        echo "2. ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²ãƒ†ã‚¹ãƒˆ"
        echo "3. ç”»åƒç”Ÿæˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
        echo ""
        echo "ğŸ›¡ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¯ä¿è­·ã•ã‚Œã¦ã„ã¾ã™" 