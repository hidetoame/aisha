import { 
  RecaptchaVerifier, 
  signInWithPhoneNumber, 
  ConfirmationResult,
  User as FirebaseUser,
  signOut
} from 'firebase/auth';
import { auth } from '../firebase';
import { User } from '../../types';

// reCAPTCHA verifier instance
let recaptchaVerifier: RecaptchaVerifier | null = null;

/**
 * reCAPTCHA verifierã‚’åˆæœŸåŒ–
 * @param containerId reCAPTCHAã‚³ãƒ³ãƒ†ãƒŠã®ID
 */
export const initializeRecaptcha = (containerId: string): RecaptchaVerifier => {
  if (recaptchaVerifier) {
    recaptchaVerifier.clear();
  }
  
  recaptchaVerifier = new RecaptchaVerifier(auth, containerId, {
    size: 'invisible',
    callback: () => {
      console.log('reCAPTCHAè§£æ±ºæ¸ˆã¿');
    },
    'expired-callback': () => {
      console.log('reCAPTCHAæœŸé™åˆ‡ã‚Œ');
    },
    'error-callback': (error: any) => {
      console.error('reCAPTCHA ã‚¨ãƒ©ãƒ¼:', error);
    }
  });
  
  return recaptchaVerifier;
};

/**
 * é›»è©±ç•ªå·ã«SMSèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡
 * @param phoneNumber é›»è©±ç•ªå·ï¼ˆ+81å½¢å¼ï¼‰
 * @param containerId reCAPTCHAã‚³ãƒ³ãƒ†ãƒŠã®ID
 * @returns ConfirmationResult
 */
export const sendSMSVerification = async (
  phoneNumber: string, 
  containerId: string
): Promise<ConfirmationResult> => {
  try {
    console.log('ğŸš€ SMSé€ä¿¡é–‹å§‹:', { phoneNumber, containerId });
    
    // æ—¥æœ¬ã®é›»è©±ç•ªå·ã‚’å›½éš›å½¢å¼ã«å¤‰æ›
    console.log('ğŸ“ é›»è©±ç•ªå·ã‚’å›½éš›å½¢å¼ã«å¤‰æ›ä¸­...');
    const internationalNumber = convertToInternationalFormat(phoneNumber);
    console.log('âœ… å›½éš›å½¢å¼å¤‰æ›å®Œäº†:', internationalNumber);
    
    // Firebaseèªè¨¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
    console.log('ğŸ”¥ Firebase Authç¢ºèª:', { 
      auth: !!auth, 
      currentUser: auth?.currentUser?.uid || 'ãªã—' 
    });
    
    // reCAPTCHA verifierã‚’åˆæœŸåŒ–
    console.log('ğŸ” reCAPTCHAåˆæœŸåŒ–ä¸­...', { containerId });
    const appVerifier = initializeRecaptcha(containerId);
    console.log('âœ… reCAPTCHAåˆæœŸåŒ–å®Œäº†');
    
    // reCAPTCHAè¦ç´ ã®å­˜åœ¨ç¢ºèª
    const recaptchaElement = document.getElementById(containerId);
    console.log('ğŸ¯ reCAPTCHAè¦ç´ ç¢ºèª:', { 
      element: !!recaptchaElement,
      id: containerId 
    });
    
    // SMSé€ä¿¡å®Ÿè¡Œ
    console.log('ğŸ“¤ Firebase SMSé€ä¿¡å®Ÿè¡Œä¸­...', { 
      number: internationalNumber,
      verifier: !!appVerifier 
    });
    
    const confirmationResult = await signInWithPhoneNumber(
      auth, 
      internationalNumber, 
      appVerifier
    );
    
    console.log('ğŸ‰ SMSé€ä¿¡æˆåŠŸ:', {
      verificationId: confirmationResult.verificationId ? 'ã‚ã‚Š' : 'ãªã—',
      number: internationalNumber
    });
    
    return confirmationResult;
  } catch (error) {
    console.error('ğŸ’¥ SMSé€ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
      error,
      errorCode: (error as any)?.code,
      errorMessage: (error as any)?.message,
      phoneNumber,
      containerId
    });
    
    // Firebase AuthçŠ¶æ…‹ã‚‚å‡ºåŠ›
    console.error('ğŸ”¥ Firebase AuthçŠ¶æ…‹:', {
      isInitialized: !!auth,
      currentUser: auth?.currentUser?.uid || 'ãªã—',
      app: !!auth?.app
    });
    
    throw new Error(getErrorMessage(error));
  }
};

/**
 * SMSèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
 * @param confirmationResult sendSMSVerificationã®çµæœ
 * @param verificationCode 6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰
 * @returns FirebaseUser
 */
export const verifySMSCode = async (
  confirmationResult: ConfirmationResult,
  verificationCode: string
): Promise<FirebaseUser> => {
  try {
    const result = await confirmationResult.confirm(verificationCode);
    console.log('SMSèªè¨¼æˆåŠŸ:', result.user.uid);
    return result.user;
  } catch (error) {
    console.error('SMSèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error(getErrorMessage(error));
  }
};

/**
 * æ—¥æœ¬ã®é›»è©±ç•ªå·ã‚’å›½éš›å½¢å¼ã«å¤‰æ›
 * @param phoneNumber æ—¥æœ¬ã®é›»è©±ç•ªå·
 * @returns å›½éš›å½¢å¼ã®é›»è©±ç•ªå·
 */
export const convertToInternationalFormat = (phoneNumber: string): string => {
  // æ•°å­—ã®ã¿æŠ½å‡º
  const numbers = phoneNumber.replace(/\D/g, '');
  
  // æ—¥æœ¬ã®é›»è©±ç•ªå·ï¼ˆ11æ¡ï¼‰ã®å ´åˆ
  if (numbers.length === 11 && numbers.startsWith('0')) {
    // æœ€åˆã®0ã‚’å‰Šé™¤ã—ã¦+81ã‚’è¿½åŠ 
    return `+81${numbers.substring(1)}`;
  }
  
  // æ—¢ã«+81å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾
  if (numbers.length === 12 && phoneNumber.startsWith('+81')) {
    return phoneNumber;
  }
  
  throw new Error('æ­£ã—ã„æ—¥æœ¬ã®é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 090-1234-5678ï¼‰');
};

/**
 * Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
 * @param firebaseUser FirebaseUser
 * @param nickname ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
 * @returns User
 */
export const convertFirebaseUserToAppUser = async (
  firebaseUser: FirebaseUser,
  nickname?: string
): Promise<User> => {
  // Firebase IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
  const idToken = await firebaseUser.getIdToken();
  
  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—/ä½œæˆ
  const API_BASE = import.meta.env.VITE_AISHA_API_BASE || 'http://localhost:7999/api';
  const response = await fetch(`${API_BASE}/firebase-auth/user-info/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${idToken}`,
    },
    body: JSON.stringify({
      firebaseUid: firebaseUser.uid,
      phoneNumber: firebaseUser.phoneNumber,
      nickname: nickname,
    }),
  });
  
  if (!response.ok) {
    console.error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Firebaseæƒ…å ±ã®ã¿ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚');
    // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€Firebaseæƒ…å ±ã®ã¿ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    return {
      id: firebaseUser.uid,
      name: nickname || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
      phoneNumber: firebaseUser.phoneNumber || '',
      isAdmin: false,
      loginType: 'phone' as const,
    };
  }
  
  const userData = await response.json();
  
  return {
    id: userData.id,
    name: userData.nickname || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
    loginType: 'phone',
    phoneNumber: userData.phoneNumber,
    isAdmin: userData.isAdmin || false,
  };
};

/**
 * ç¾åœ¨ã®Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
 * @returns IDãƒˆãƒ¼ã‚¯ãƒ³
 */
export const getCurrentUserIdToken = async (): Promise<string | null> => {
  const user = auth.currentUser;
  if (user) {
    return await user.getIdToken();
  }
  return null;
};

/**
 * Firebaseèªè¨¼ã‚’ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
 */
export const signOutFirebase = async (): Promise<void> => {
  try {
    await signOut(auth);
    if (recaptchaVerifier) {
      recaptchaVerifier.clear();
      recaptchaVerifier = null;
    }
    console.log('Firebaseèªè¨¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
  } catch (error) {
    console.error('Firebaseèªè¨¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  }
};

/**
 * reCAPTCHAã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
 */
export const cleanupRecaptcha = (): void => {
  if (recaptchaVerifier) {
    recaptchaVerifier.clear();
    recaptchaVerifier = null;
  }
};

/**
 * Firebaseã‚¨ãƒ©ãƒ¼ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
 * @param error Firebaseã‚¨ãƒ©ãƒ¼
 * @returns ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
const getErrorMessage = (error: any): string => {
  const errorCode = error?.code || '';
  
  switch (errorCode) {
    case 'auth/invalid-phone-number':
      return 'ç„¡åŠ¹ãªé›»è©±ç•ªå·ã§ã™ã€‚æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    case 'auth/missing-phone-number':
      return 'é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    case 'auth/quota-exceeded':
      return 'SMSé€ä¿¡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
    case 'auth/invalid-verification-code':
      return 'èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
    case 'auth/invalid-verification-id':
      return 'èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚';
    case 'auth/code-expired':
      return 'èªè¨¼ã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚';
    case 'auth/too-many-requests':
      return 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
    case 'auth/captcha-check-failed':
      return 'reCAPTCHAèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
    default:
      return error?.message || 'èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
  }
};