#!/usr/bin/env python
import os
import sys
import django

# Djangoè¨­å®šã‚’èª­ã¿è¾¼ã¿
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'django_project.settings')
django.setup()

from api.models.credit_charge import CreditCharge
from api.models.payment_log import PaymentLog

def check_payment_data():
    print("=== æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ã®èª¿æŸ» ===")
    print()
    
    # CreditChargeãƒ†ãƒ¼ãƒ–ãƒ«ã®çµ±è¨ˆ
    print("ğŸ“Š CreditCharge ãƒ†ãƒ¼ãƒ–ãƒ«:")
    total_charges = CreditCharge.objects.count()
    pending_charges = CreditCharge.objects.filter(payment_status='pending').count()
    succeeded_charges = CreditCharge.objects.filter(payment_status='succeeded').count()
    failed_charges = CreditCharge.objects.filter(payment_status='failed').count()
    
    print(f"  ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {total_charges}")
    print(f"  pending: {pending_charges}")
    print(f"  succeeded: {succeeded_charges}")
    print(f"  failed: {failed_charges}")
    print()
    
    # PaymentLogãƒ†ãƒ¼ãƒ–ãƒ«ã®çµ±è¨ˆ
    print("ğŸ“Š PaymentLog ãƒ†ãƒ¼ãƒ–ãƒ«:")
    total_logs = PaymentLog.objects.count()
    pending_logs = PaymentLog.objects.filter(status='pending').count()
    success_logs = PaymentLog.objects.filter(status='success').count()
    failed_logs = PaymentLog.objects.filter(status='failed').count()
    
    print(f"  ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {total_logs}")
    print(f"  pending: {pending_logs}")
    print(f"  success: {success_logs}")
    print(f"  failed: {failed_logs}")
    print()
    
    # æœ€æ–°ã®CreditChargeãƒ¬ã‚³ãƒ¼ãƒ‰
    print("ğŸ•’ æœ€æ–°ã®CreditChargeãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆæœ€æ–°5ä»¶ï¼‰:")
    recent_charges = CreditCharge.objects.order_by('-created_at')[:5]
    for charge in recent_charges:
        print(f"  ID: {charge.id}")
        print(f"    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {charge.payment_status}")
        print(f"    é‡‘é¡: Â¥{charge.charge_amount}")
        print(f"    ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: {charge.credit_amount}")
        print(f"    ä½œæˆæ—¥æ™‚: {charge.created_at}")
        print(f"    å®Œäº†æ—¥æ™‚: {charge.completed_at}")
        print(f"    Stripe ID: {charge.stripe_payment_intent_id}")
        print()
    
    # æœ€æ–°ã®PaymentLogãƒ¬ã‚³ãƒ¼ãƒ‰
    print("ğŸ•’ æœ€æ–°ã®PaymentLogãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆæœ€æ–°5ä»¶ï¼‰:")
    recent_logs = PaymentLog.objects.order_by('-created_at')[:5]
    for log in recent_logs:
        print(f"  ID: {log.id}")
        print(f"    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {log.status}")
        print(f"    é‡‘é¡: {log.amount} {log.currency}")
        print(f"    ä½œæˆæ—¥æ™‚: {log.created_at}")
        print(f"    Stripe ID: {log.payment_intent_id}")
        print(f"    Webhookã‚¿ã‚¤ãƒ—: {log.webhook_event_type}")
        print(f"    å‡¦ç†æ¸ˆã¿: {log.processed}")
        print()
    
    # è¬ã®å‡¦ç†ä¸­ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è©³ç´°
    print("ğŸ” å‡¦ç†ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è©³ç´°èª¿æŸ»:")
    pending_charges_detail = CreditCharge.objects.filter(payment_status='pending')
    if pending_charges_detail.exists():
        print(f"  CreditChargeã§å‡¦ç†ä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰: {pending_charges_detail.count()}ä»¶")
        for charge in pending_charges_detail:
            print(f"    ID: {charge.id}, é‡‘é¡: Â¥{charge.charge_amount}, ä½œæˆ: {charge.created_at}")
    else:
        print("  CreditChargeã«å‡¦ç†ä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“")
    
    pending_logs_detail = PaymentLog.objects.filter(status='pending')
    if pending_logs_detail.exists():
        print(f"  PaymentLogã§å‡¦ç†ä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰: {pending_logs_detail.count()}ä»¶")
        for log in pending_logs_detail:
            print(f"    ID: {log.id}, é‡‘é¡: {log.amount}, ä½œæˆ: {log.created_at}, Webhook: {log.webhook_event_type}")
    else:
        print("  PaymentLogã«å‡¦ç†ä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“")

if __name__ == "__main__":
    check_payment_data() 