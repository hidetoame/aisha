#!/usr/bin/env python
"""
ç¾åœ¨ã®api_configè¨­å®šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã€SUZURI APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèª
"""
import os
import sys
import django

# Djangoè¨­å®šã‚’èª­ã¿è¾¼ã¿
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'django_project.settings')
django.setup()

from api.models.goods_management import GoodsManagement
from api.services.suzuri_api_service import SuzuriAPIService

def test_current_api_config():
    """ç¾åœ¨ã®api_configè¨­å®šã‚’ãƒ†ã‚¹ãƒˆ"""
    
    print("=== ç¾åœ¨ã®api_configè¨­å®šãƒ†ã‚¹ãƒˆ ===")
    
    try:
        # å…¬é–‹ä¸­ã®å•†å“ã‚’å–å¾—
        goods_list = GoodsManagement.objects.filter(is_public=True).order_by('display_order')
        
        for goods in goods_list:
            print(f"\nğŸ” {goods.display_name} (ID: {goods.suzuri_item_id})")
            print(f"   api_config: {goods.api_config}")
            
            # api_configã®æ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
            if not goods.api_config:
                print("   âŒ api_configãŒç©ºã§ã™")
                continue
            
            # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
            required_fields = ['itemId', 'exemplaryItemVariantId']
            missing_fields = []
            
            for field in required_fields:
                if field not in goods.api_config:
                    missing_fields.append(field)
            
            if missing_fields:
                print(f"   âŒ å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: {missing_fields}")
            else:
                print("   âœ… å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰OK")
            
            # itemIdã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯
            if goods.api_config.get('itemId') != goods.suzuri_item_id:
                print(f"   âŒ itemIdãŒä¸€è‡´ã—ã¾ã›ã‚“: DB={goods.suzuri_item_id}, config={goods.api_config.get('itemId')}")
            else:
                print("   âœ… itemIDä¸€è‡´")
            
            # ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
            unnecessary_fields = ['sub_materials']
            found_unnecessary = []
            
            for field in unnecessary_fields:
                if field in goods.api_config:
                    found_unnecessary.append(field)
            
            if found_unnecessary:
                print(f"   âš ï¸ ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚ã‚Š: {found_unnecessary}")
        
        print(f"\n=== æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹ ===")
        print("åŸºæœ¬å½¢å¼:")
        print({
            "itemId": 123,
            "exemplaryItemVariantId": 456,
            "published": True,
            "resizeMode": "contain"  # å•†å“ã«ã‚ˆã‚‹
        })
        
        print("\nè¤‡æ•°é¢ãƒ—ãƒªãƒ³ãƒˆæ™‚ã®ã¿:")
        print({
            "itemId": 123,
            "exemplaryItemVariantId": 456, 
            "published": True,
            "resizeMode": "contain",
            "sub_materials": [
                {
                    "texture": "base64_image_data",
                    "printSide": "back",
                    "enabled": True
                }
            ]
        })
        
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}")
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    test_current_api_config()
