#!/usr/bin/env python3
"""
ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import os
import io
from PIL import Image
from google.cloud import storage
from google.oauth2 import service_account

def create_test_image():
    """ãƒ†ã‚¹ãƒˆç”¨ã®ç”»åƒã‚’ä½œæˆ"""
    # 200x200ã®èµ¤ã„ç”»åƒã‚’ä½œæˆ
    img = Image.new('RGB', (200, 200), color='red')
    
    # ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ä¿å­˜
    img_byte_arr = io.BytesIO()
    img.save(img_byte_arr, format='PNG')
    img_byte_arr.seek(0)
    
    return img_byte_arr.getvalue()

def test_image_upload():
    print("=== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ ===\n")
    
    # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
    gcs_project_id = os.getenv('GCS_PROJECT_ID')
    gcs_bucket_name = os.getenv('GCS_BUCKET_NAME')
    google_application_credentials = os.getenv('GOOGLE_APPLICATION_CREDENTIALS')
    
    if not all([gcs_project_id, gcs_bucket_name]):
        print("âŒ ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return False
    
    try:
        # èªè¨¼æƒ…å ±ã®ä½œæˆ
        print("1. èªè¨¼æƒ…å ±ã®ä½œæˆ...")
        if google_application_credentials and os.path.exists(google_application_credentials):
            credentials = service_account.Credentials.from_service_account_file(google_application_credentials)
            print("   âœ… èªè¨¼æƒ…å ±ä½œæˆæˆåŠŸ")
        else:
            print("   âŒ èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return False
        
        # GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
        print("2. GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ...")
        client = storage.Client(credentials=credentials, project=gcs_project_id)
        bucket = client.bucket(gcs_bucket_name)
        print("   âœ… GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆæˆåŠŸ")
        
        # ãƒ†ã‚¹ãƒˆç”»åƒã®ä½œæˆ
        print("3. ãƒ†ã‚¹ãƒˆç”»åƒã®ä½œæˆ...")
        image_data = create_test_image()
        print(f"   âœ… ãƒ†ã‚¹ãƒˆç”»åƒä½œæˆæˆåŠŸ ({len(image_data)} bytes)")
        
        # ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        print("4. ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...")
        blob_name = f"test_images/test_image_{os.urandom(4).hex()}.png"
        blob = bucket.blob(blob_name)
        
        blob.upload_from_string(
            image_data,
            content_type='image/png'
        )
        print(f"   âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: {blob_name}")
        
        # ç”»åƒæƒ…å ±ã®ç¢ºèª
        print("5. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®æƒ…å ±ç¢ºèª...")
        blob.reload()
        print(f"   ãƒ•ã‚¡ã‚¤ãƒ«å: {blob.name}")
        print(f"   ã‚µã‚¤ã‚º: {blob.size} bytes")
        print(f"   Content-Type: {blob.content_type}")
        print(f"   ä½œæˆæ—¥æ™‚: {blob.time_created}")
        
        # ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèª
        print("6. ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèª...")
        downloaded_data = blob.download_as_bytes()
        if len(downloaded_data) == len(image_data):
            print("   âœ… ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼ˆã‚µã‚¤ã‚ºä¸€è‡´ï¼‰")
        else:
            print("   âŒ ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºãŒä¸€è‡´ã—ã¾ã›ã‚“")
            return False
        
        # å…¬é–‹URLã®å–å¾—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        print("7. ç”»åƒURLã®å–å¾—...")
        # Note: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯éå…¬é–‹ãªã®ã§ã€ç½²åä»˜ãURLã‚’ç”Ÿæˆ
        from datetime import timedelta
        url = blob.generate_signed_url(
            version="v4",
            expiration=timedelta(hours=1),
            method="GET"
        )
        print(f"   ã‚¢ã‚¯ã‚»ã‚¹URLï¼ˆ1æ™‚é–“æœ‰åŠ¹ï¼‰:")
        print(f"   {url[:100]}...")
        
        # ãƒ†ã‚¹ãƒˆç”»åƒã®å‰Šé™¤
        print("8. ãƒ†ã‚¹ãƒˆç”»åƒã®å‰Šé™¤...")
        blob.delete()
        print("   âœ… ãƒ†ã‚¹ãƒˆç”»åƒå‰Šé™¤æˆåŠŸ")
        
        print("\nğŸ‰ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼")
        return True
        
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        return False

if __name__ == "__main__":
    success = test_image_upload()
    exit(0 if success else 1)
