#!/usr/bin/env python3
"""
決済履歴のテスト用データ作成スクリプト
"""

import requests
import json
from datetime import datetime, timedelta

def create_test_payment_history():
    """テスト用の決済履歴を作成"""
    api_url = "http://localhost:7999/api/charges/"
    
    # テスト用の決済履歴データ
    test_payments = [
        {
            "user_id": "demo_user",
            "charge_amount": 500.00,
            "credit_amount": 500
        },
        {
            "user_id": "demo_user", 
            "charge_amount": 1000.00,
            "credit_amount": 1100
        },
        {
            "user_id": "demo_user",
            "charge_amount": 500.00,
            "credit_amount": 500
        }
    ]
    
    print("テスト用決済履歴作成開始...")
    print(f"URL: {api_url}")
    
    created_charges = []
    
    for i, payment_data in enumerate(test_payments):
        print(f"\n{i+1}. 決済履歴作成中...")
        print(f"データ: {json.dumps(payment_data, indent=2)}")
        
        try:
            response = requests.post(
                api_url,
                json=payment_data,
                headers={'Content-Type': 'application/json'},
                timeout=30
            )
            
            print(f"レスポンス ステータス: {response.status_code}")
            
            if response.status_code == 201:
                result = response.json()
                print(f"成功: {json.dumps(result, indent=2)}")
                created_charges.append(result)
            else:
                print(f"エラー: {response.text}")
                
        except Exception as e:
            print(f"例外発生: {e}")
    
    return created_charges

def test_payment_history_api():
    """決済履歴取得APIのテスト"""
    user_id = "demo_user"
    api_url = f"http://localhost:7999/api/users/{user_id}/charge-history/"
    
    print(f"\n決済履歴取得APIテスト開始...")
    print(f"URL: {api_url}")
    
    try:
        response = requests.get(api_url, timeout=10)
        
        print(f"\nレスポンス:")
        print(f"ステータス: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            print(f"成功: {json.dumps(result, indent=2)}")
            
            # 履歴件数をチェック
            count = result.get('count', 0)
            results = result.get('results', [])
            print(f"✅ 取得件数: {len(results)} / 全体: {count} 件")
            
            # 各履歴の内容をチェック
            for idx, history in enumerate(results):
                print(f"履歴 {idx+1}:")
                print(f"  - ID: {history.get('id')}")
                print(f"  - 金額: ¥{history.get('charge_amount')}")
                print(f"  - クレジット: {history.get('credit_amount')}")
                print(f"  - ステータス: {history.get('payment_status')}")
                print(f"  - 作成日時: {history.get('created_at')}")
        else:
            print(f"エラー: {response.text}")
            
    except Exception as e:
        print(f"例外発生: {e}")

if __name__ == "__main__":
    # テスト用決済履歴を作成
    charges = create_test_payment_history()
    
    # 少し待ってから履歴を取得
    print("\n3秒待機...")
    import time
    time.sleep(3)
    
    # 決済履歴取得APIをテスト
    test_payment_history_api()
