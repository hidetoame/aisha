#!/usr/bin/env python3
"""
Google Cloud Storageæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
"""

import os
import json
from google.cloud import storage
from google.oauth2 import service_account

def test_gcp_connection():
    print("=== Google Cloud Storageæ¥ç¶šãƒ†ã‚¹ãƒˆ ===\n")
    
    # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
    print("1. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª...")
    gcs_project_id = os.getenv('GCS_PROJECT_ID')
    gcs_bucket_name = os.getenv('GCS_BUCKET_NAME')
    gcs_credentials_json = os.getenv('GCS_CREDENTIALS_JSON')
    google_application_credentials = os.getenv('GOOGLE_APPLICATION_CREDENTIALS')
    
    print(f"   GCS_PROJECT_ID: {gcs_project_id}")
    print(f"   GCS_BUCKET_NAME: {gcs_bucket_name}")
    print(f"   GCS_CREDENTIALS_JSON: {'è¨­å®šã‚ã‚Š' if gcs_credentials_json else 'è¨­å®šãªã—'}")
    print(f"   GOOGLE_APPLICATION_CREDENTIALS: {google_application_credentials}")
    print()
    
    if not all([gcs_project_id, gcs_bucket_name]):
        print("âŒ ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return False
    
    try:
        # èªè¨¼æƒ…å ±ã®ä½œæˆ
        print("2. èªè¨¼æƒ…å ±ã®ä½œæˆ...")
        credentials = None
        
        # æ–¹æ³•1: GOOGLE_APPLICATION_CREDENTIALS ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‹ã‚‰èª­ã¿è¾¼ã¿
        if google_application_credentials and os.path.exists(google_application_credentials):
            print(f"   èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿: {google_application_credentials}")
            credentials = service_account.Credentials.from_service_account_file(google_application_credentials)
            print("   âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®èªè¨¼æƒ…å ±ä½œæˆã«æˆåŠŸ")
        
        # æ–¹æ³•2: GCS_CREDENTIALS_JSON ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¿
        elif gcs_credentials_json:
            print("   ç’°å¢ƒå¤‰æ•°ã®JSONæ–‡å­—åˆ—ã‹ã‚‰èª­ã¿è¾¼ã¿")
            credentials_info = json.loads(gcs_credentials_json)
            credentials = service_account.Credentials.from_service_account_info(credentials_info)
            print("   âœ… JSONæ–‡å­—åˆ—ã‹ã‚‰ã®èªè¨¼æƒ…å ±ä½œæˆã«æˆåŠŸ")
        
        # æ–¹æ³•3: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨
        else:
            print("   ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨")
            credentials = None  # storage.ClientãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼ã‚’ä½¿ç”¨
        
        print()
        
        # GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
        print("3. GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ...")
        if credentials:
            client = storage.Client(credentials=credentials, project=gcs_project_id)
        else:
            client = storage.Client(project=gcs_project_id)
        print("   âœ… GCSã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«æˆåŠŸ")
        print()
        
        # ãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
        print("4. ãƒã‚±ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª...")
        bucket = client.bucket(gcs_bucket_name)
        if bucket.exists():
            print(f"   âœ… ãƒã‚±ãƒƒãƒˆ '{gcs_bucket_name}' ãŒå­˜åœ¨ã—ã¾ã™")
        else:
            print(f"   âŒ ãƒã‚±ãƒƒãƒˆ '{gcs_bucket_name}' ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
            return False
        print()
        
        # ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—
        print("5. ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—...")
        bucket.reload()
        print(f"   ãƒã‚±ãƒƒãƒˆå: {bucket.name}")
        print(f"   ä½œæˆæ—¥æ™‚: {bucket.time_created}")
        print(f"   ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: {bucket.location}")
        print(f"   ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒ©ã‚¹: {bucket.storage_class}")
        print()
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ï¼ˆæœ€å¤§5ä»¶ï¼‰
        print("6. ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ï¼ˆæœ€å¤§5ä»¶ï¼‰...")
        blobs = list(bucket.list_blobs(max_results=5))
        if blobs:
            print(f"   æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(blobs)}ä»¶")
            for blob in blobs:
                print(f"   - {blob.name} ({blob.size} bytes)")
        else:
            print("   ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç©ºã®ãƒã‚±ãƒƒãƒˆï¼‰")
        print()
        
        # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        print("7. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...")
        test_content = "GCSæ¥ç¶šãƒ†ã‚¹ãƒˆ - " + str(os.urandom(8).hex())
        test_blob_name = f"test/connection_test_{os.urandom(4).hex()}.txt"
        
        blob = bucket.blob(test_blob_name)
        blob.upload_from_string(test_content, content_type='text/plain')
        print(f"   âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« '{test_blob_name}' ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸ")
        print()
        
        # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        print("8. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰...")
        downloaded_content = blob.download_as_text()
        if downloaded_content == test_content:
            print("   âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸï¼ˆå†…å®¹ä¸€è‡´ï¼‰")
        else:
            print("   âŒ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒä¸€è‡´ã—ã¾ã›ã‚“")
            return False
        print()
        
        # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
        print("9. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤...")
        blob.delete()
        print("   âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«æˆåŠŸ")
        print()
        
        print("ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼GCPæ¥ç¶šã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚")
        return True
        
    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æã‚¨ãƒ©ãƒ¼: {e}")
        return False
    except Exception as e:
        print(f"âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
        return False

if __name__ == "__main__":
    # .env.devãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
    env_file = ".env.dev"
    if os.path.exists(env_file):
        print(f"ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« '{env_file}' ã‚’èª­ã¿è¾¼ã¿ä¸­...\n")
        with open(env_file, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    # å€¤ãŒã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å»
                    if value.startswith('"') and value.endswith('"'):
                        value = value[1:-1]
                    elif value.startswith("'") and value.endswith("'"):
                        value = value[1:-1]
                    os.environ[key.strip()] = value.strip()
    else:
        print(f"âš ï¸  è­¦å‘Š: ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« '{env_file}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n")
    
    success = test_gcp_connection()
    exit(0 if success else 1)
