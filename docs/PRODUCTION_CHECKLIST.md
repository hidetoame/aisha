# 本番環境デプロイチェックリスト

## 事前準備

### 1. シークレット管理
- [ ] すべての秘密鍵を.envファイルから削除
- [ ] GitHub Secretsにすべての必要な環境変数を設定
- [ ] Google Secret Managerに機密情報を保存
- [ ] サービスアカウントの権限を最小限に設定

### 2. データベース
- [ ] Cloud SQL (aisha-db) の接続設定を確認
- [ ] データベースのバックアップを設定
- [ ] 本番用のユーザーとパスワードを作成
- [ ] SSL接続を有効化

### 3. セキュリティ設定
- [ ] Django: DEBUG=False を確認
- [ ] Django: ALLOWED_HOSTS を適切に設定
- [ ] CORS設定を本番用に調整
- [ ] CSRFトークンの設定を確認

### 4. API Keys
- [ ] Stripe本番キーに切り替え
- [ ] Firebase本番プロジェクトの設定
- [ ] その他のAPI（SUZURI、Gemini等）の本番キー設定

## デプロイ前の確認

### 1. コード品質
- [ ] console.logステートメントを削除（完了済み）
- [ ] 未使用のインポートを削除（完了済み）
- [ ] エラーハンドリングを確認
- [ ] TypeScriptのビルドエラーがないことを確認

### 2. パフォーマンス
- [ ] 画像の最適化
- [ ] バンドルサイズの確認（現在: 1,118KB）
- [ ] Lazy loadingの実装確認

### 3. 機能テスト
- [ ] ユーザー認証フロー
- [ ] 決済フロー（Stripe）
- [ ] 画像生成・保存フロー
- [ ] グッズ作成フロー

## デプロイ手順

1. **GitHub Secretsの設定**
   ```
   - GCP_SA_KEY
   - DJANGO_SECRET_KEY
   - DATABASE_URL
   - STRIPE関連のキー
   - Firebase関連のキー
   - その他のAPIキー
   ```

2. **Cloud SQLの準備**
   ```bash
   # データベースとユーザーの作成
   # マイグレーションの実行
   python manage.py migrate
   ```

3. **デプロイの実行**
   ```bash
   # mainブランチにプッシュ
   git push origin main
   ```

## デプロイ後の確認

### 1. 動作確認
- [ ] フロントエンドのURL確認
- [ ] バックエンドAPIの疎通確認
- [ ] データベース接続確認
- [ ] 外部API連携確認

### 2. 監視設定
- [ ] Cloud Runのメトリクス監視
- [ ] エラーログの監視
- [ ] アラートの設定
- [ ] アップタイム監視

### 3. バックアップ
- [ ] データベースの自動バックアップ確認
- [ ] 画像ストレージのバックアップ設定
- [ ] 設定ファイルのバックアップ

## トラブルシューティング

### よくある問題

1. **502 Bad Gateway**
   - Cloud SQLの接続確認
   - 環境変数の設定確認
   - コンテナのメモリ不足確認

2. **CORS エラー**
   - ALLOWED_HOSTSの設定確認
   - フロントエンドとバックエンドのURL確認

3. **認証エラー**
   - Firebase設定の確認
   - JWTトークンの有効期限確認

## ロールバック手順

1. Cloud Runで以前のリビジョンに切り替え
2. 必要に応じてデータベースのロールバック
3. GitHub Actionsで以前のコミットを再デプロイ